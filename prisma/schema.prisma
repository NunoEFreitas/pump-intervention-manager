// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String         @id @default(uuid())
  email                   String         @unique
  password                String
  name                    String
  role                    UserRole       @default(TECHNICIAN)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  assignedInterventions   Intervention[] @relation("AssignedInterventions")
  createdInterventions    Intervention[] @relation("CreatedInterventions")
  warehouseItems          TechnicianStock[] @relation("TechnicianWarehouse")
  serialNumbers           SerialNumberStock[] @relation("TechnicianSerialNumbers")
  itemMovementsFrom       ItemMovement[] @relation("MovementFrom")
  itemMovementsTo         ItemMovement[] @relation("MovementTo")
  itemMovementsCreated    ItemMovement[] @relation("MovementCreatedBy")
}

enum UserRole {
  ADMIN
  SUPERVISOR
  TECHNICIAN
}

enum ClientType {
  PRIVATE
  COMPANY
}

model Client {
  id            String            @id @default(uuid())
  clientType    ClientType        @default(PRIVATE)
  name          String
  address       String?
  city          String?
  postalCode    String?
  phone         String?
  email         String?
  contactPerson String?
  notes         String?           @db.Text
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  interventions Intervention[]
  locations     CompanyLocation[]
}

model CompanyLocation {
  id            String              @id @default(uuid())
  clientId      String
  client        Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name          String
  address       String?
  city          String?
  postalCode    String?
  phone         String?
  contactPerson String?
  notes         String?             @db.Text
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  interventions Intervention[]
  equipment     LocationEquipment[]
}

model EquipmentType {
  id        String              @id @default(uuid())
  name      String              @unique
  createdAt DateTime            @default(now())
  equipment LocationEquipment[]
}

model EquipmentBrand {
  id        String              @id @default(uuid())
  name      String              @unique
  createdAt DateTime            @default(now())
  equipment LocationEquipment[]
}

model LocationEquipment {
  id              String          @id @default(uuid())
  locationId      String
  location        CompanyLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  equipmentTypeId String
  equipmentType   EquipmentType   @relation(fields: [equipmentTypeId], references: [id])
  brandId         String
  brand           EquipmentBrand  @relation(fields: [brandId], references: [id])
  model           String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Intervention {
  id               String              @id @default(uuid())
  clientId         String
  client           Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  locationId       String?
  location         CompanyLocation?    @relation(fields: [locationId], references: [id])
  assignedToId     String
  assignedTo       User                @relation("AssignedInterventions", fields: [assignedToId], references: [id])
  createdById      String?
  createdBy        User?               @relation("CreatedInterventions", fields: [createdById], references: [id])
  status           InterventionStatus  @default(OPEN)
  scheduledDate    DateTime
  scheduledTime    String
  breakdown        String              @default("") @db.Text // Description of the breakdown/issue
  workDone         String?             @db.Text
  timeSpent        Float?              // in hours
  description      String?             @db.Text
  partsUsed        InterventionPart[]  // Parts used in this intervention
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

// Track parts used in interventions
model InterventionPart {
  id              String        @id @default(uuid())
  interventionId  String
  intervention    Intervention  @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  itemId          String
  item            WarehouseItem @relation(fields: [itemId], references: [id])
  quantity        Int
  serialNumberIds String[]      // Array of serial number IDs if item tracks SNs
  createdAt       DateTime      @default(now())

  @@index([interventionId])
  @@index([itemId])
}

enum InterventionStatus {
  OPEN
  IN_PROGRESS
  QUALITY_ASSESSMENT
  COMPLETED
  CANCELED
}

model WarehouseItem {
  id                  String              @id @default(uuid())
  itemName            String
  partNumber          String
  value               Float
  mainWarehouse       Int                 @default(0)  // Count for non-serialized items
  tracksSerialNumbers Boolean             @default(false) // Whether this item uses SN tracking
  autoSn              Boolean             @default(false) // Auto-generate serial numbers on add stock
  snExample           String?             // Prefix for auto-generated SNs (e.g. "PTT" â†’ "PTT-1", "PTT-2")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  movements           ItemMovement[]
  technicianStocks    TechnicianStock[]
  serialNumbers       SerialNumberStock[]
  interventionParts   InterventionPart[]
}

model TechnicianStock {
  id              String          @id @default(uuid())
  itemId          String
  item            WarehouseItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  technicianId    String
  technician      User            @relation("TechnicianWarehouse", fields: [technicianId], references: [id], onDelete: Cascade)
  quantity        Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([itemId, technicianId])
}

model ItemMovement {
  id              String                  @id @default(uuid())
  itemId          String
  item            WarehouseItem           @relation(fields: [itemId], references: [id], onDelete: Cascade)
  movementType    MovementType
  quantity        Int
  fromUserId      String?
  fromUser        User?                   @relation("MovementFrom", fields: [fromUserId], references: [id])
  toUserId        String?
  toUser          User?                   @relation("MovementTo", fields: [toUserId], references: [id])
  notes           String?                 @db.Text
  createdById     String
  createdBy       User                    @relation("MovementCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime                @default(now())
  serialNumbers   MovementSerialNumber[]  // Track which SNs were moved
}

enum MovementType {
  ADD_STOCK           // Add to main warehouse
  REMOVE_STOCK        // Remove from main warehouse (loss, damage, etc)
  TRANSFER_TO_TECH    // Transfer from main to technician
  TRANSFER_FROM_TECH  // Return from technician to main
  USE                 // Used in intervention
}

// Track individual serial numbers for items
model SerialNumberStock {
  id              String                  @id @default(uuid())
  itemId          String
  item            WarehouseItem           @relation(fields: [itemId], references: [id], onDelete: Cascade)
  serialNumber    String                  // The actual serial number
  location        StockLocation           @default(MAIN_WAREHOUSE)
  technicianId    String?
  technician      User?                   @relation("TechnicianSerialNumbers", fields: [technicianId], references: [id])
  status          SerialStatus            @default(AVAILABLE)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  movements       MovementSerialNumber[]

  @@unique([itemId, serialNumber]) // Serial number must be unique per item
}

enum StockLocation {
  MAIN_WAREHOUSE
  TECHNICIAN
  USED
}

enum SerialStatus {
  AVAILABLE
  IN_USE
  DAMAGED
  LOST
}

// Join table for movements and serial numbers
model MovementSerialNumber {
  id              String            @id @default(uuid())
  movementId      String
  movement        ItemMovement      @relation(fields: [movementId], references: [id], onDelete: Cascade)
  serialNumberId  String
  serialNumber    SerialNumberStock @relation(fields: [serialNumberId], references: [id], onDelete: Cascade)

  @@unique([movementId, serialNumberId])
}
